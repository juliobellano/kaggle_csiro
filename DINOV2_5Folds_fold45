{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "1c0c7c3f",
   "metadata": {
    "_cell_guid": "b1076dfc-b9ad-4769-8c92-a6c4dae69d19",
    "_uuid": "8f2839f25d086af736a60e9eeb907d3b93b6e0e5",
    "collapsed": true,
    "execution": {
     "iopub.execute_input": "2025-12-23T03:22:35.205120Z",
     "iopub.status.busy": "2025-12-23T03:22:35.204845Z",
     "iopub.status.idle": "2025-12-23T03:22:36.438403Z",
     "shell.execute_reply": "2025-12-23T03:22:36.437744Z"
    },
    "jupyter": {
     "outputs_hidden": true
    },
    "papermill": {
     "duration": 1.238617,
     "end_time": "2025-12-23T03:22:36.439972",
     "exception": false,
     "start_time": "2025-12-23T03:22:35.201355",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "/kaggle/input/csiro-dinov2-fold0/pytorch/default/1/.virtual_documents/__notebook_source__.ipynb\n",
      "/kaggle/input/csiro-biomass/sample_submission.csv\n",
      "/kaggle/input/csiro-biomass/train.csv\n",
      "/kaggle/input/csiro-biomass/test.csv\n",
      "/kaggle/input/csiro-biomass/test/ID1001187975.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2099464826.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2037861084.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1211362607.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1853508321.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID193102215.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID698608346.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1859251563.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1880764911.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID853954911.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1403107574.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1781353117.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID384648061.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1563418511.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2125100696.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID482555369.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID638711343.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID779628955.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1876271942.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1692894460.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID746335827.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1136169672.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1471216911.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID846154859.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1294770420.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1183807388.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID423506847.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1889150649.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1140993511.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1413758094.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1545077474.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID95050718.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID528010569.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1645161155.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID786365141.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID896386823.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1025234388.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID663006174.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1509266870.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1496750796.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID471758347.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID740402124.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1624268863.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1098771283.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID710341728.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2086966681.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1573329652.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID54128926.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID50027657.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1559189397.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID290369222.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1590632667.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID552040066.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID488873801.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID363069566.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1839139621.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1131079710.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2010625680.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID152157478.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1357758282.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1498398599.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID679913293.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID697718693.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID4464212.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1275072698.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1579942839.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID799079114.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1415329644.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1510574031.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1078930021.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1456861072.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID930534670.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID13162390.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID567744300.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID344618040.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID566966892.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1437386574.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID667059550.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID72895391.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1193692654.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1386202352.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID871463897.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2096636211.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2003438517.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID21377800.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID230058600.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1753847361.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1512751450.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID12390962.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1746343319.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID978026131.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID383231615.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID146920896.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1036339023.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1168534540.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1859792585.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1251029854.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1113329413.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1874904894.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1671844336.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1831254380.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1103883611.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID797502182.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1784585001.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1058383417.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1488408526.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID429799190.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1291116815.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1516374298.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1618597318.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1345375788.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID686797154.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1139866256.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1149598723.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID212206250.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID112966473.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1540480250.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID544444725.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1513184765.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID668330410.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1444674500.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1962379474.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID605134229.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID914754166.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID354528442.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID950496197.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1395011773.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1357768767.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID210865340.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID936984905.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1976436386.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1215977190.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID803479541.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1244346858.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID158170916.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1208644039.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1314135397.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1012260530.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1053972079.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID656251220.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1084819986.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1337107565.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1268934251.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID617132135.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1472525822.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID668475812.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID681680726.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1476045099.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1570190541.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1403078396.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2030696575.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1782608354.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID194823383.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID196516535.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID212206832.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1638922597.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1457700382.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1989506559.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID789169173.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1634731537.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1428837636.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2006686196.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID885388135.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1789853061.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1655778545.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID697059386.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID121331988.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2099742797.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID342818398.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID317990700.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID706288721.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1159071020.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID755710743.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1254829053.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID475010202.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1693880739.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1894998379.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID48303557.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1385921939.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID147528735.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID407646960.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1035947949.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1119761112.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1988033238.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1857489997.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID742198710.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID588120964.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID431471530.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID353424190.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID380752847.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2069766023.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID600602588.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID560946727.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1011485656.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID808079729.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1217108125.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1623964968.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID980878870.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID793526563.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID397994621.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID975115267.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1237349078.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID684383343.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID866684633.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1665142816.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2048645043.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1953171547.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1451025862.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID71885430.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID307060225.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID969218269.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID980538882.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1028611175.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID670276799.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2002797732.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1374789439.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID473494649.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1993907137.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1962197151.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID828217731.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID972274220.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1954669045.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1354190372.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1458758610.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID40849327.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1952813879.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID572336285.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1473228876.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1963715583.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1463690813.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1899025384.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID386216505.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1789265307.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID315357834.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2089023774.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID520514019.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1970522802.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1139918758.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1051144034.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1370004842.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID761508093.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2052993274.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1277756619.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID6269659.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1574125908.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID135365668.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1182523622.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID554314721.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1049634115.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1127246618.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID900012207.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID574213894.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID415656958.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID61833032.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2053315094.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID550623196.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID657448172.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1675365449.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2014192906.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID162394992.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID968643034.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID684062938.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID802547515.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID294150104.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1618145129.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID956512130.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID142751858.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID325799913.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID443091455.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID661372352.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1062837331.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID498304885.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID187238869.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1450399782.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2056023629.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID576621307.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1199150612.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1411613934.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID105271783.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1703304524.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID875119737.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1176292407.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1729002155.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2091439402.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID576137678.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1946311744.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1982662138.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID983582017.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID661817669.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID753699705.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1789834546.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID529933668.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID490139972.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID743847993.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID7850481.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1088965591.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID629980789.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1119739385.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1477176296.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1113121340.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2131261930.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2145635095.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1414371018.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1148666289.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID839432753.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID157479394.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1761544403.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID846984946.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID751517087.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID577112774.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID353997899.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID748979397.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1070112260.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1108283583.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1868719645.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1980675327.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1163061745.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1148528732.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID534966093.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1717006117.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1953218650.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID633775166.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID808093827.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1997244125.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1920959057.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1948354837.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID364856705.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID249042826.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID332742639.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1680597197.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1421714468.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID905397692.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1782509721.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID141370843.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2056982009.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID94564238.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID8209776.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID908524512.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID610397481.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID750820644.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1515990019.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1547945326.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID587125778.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1620371305.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1474775613.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID545360459.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1783499590.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1249094008.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1525817840.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID227847873.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1052620238.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1888700589.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID2052442675.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID963903358.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1121692672.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1343327476.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID1667778338.jpg\n",
      "/kaggle/input/csiro-biomass/train/ID257822026.jpg\n"
     ]
    }
   ],
   "source": [
    "# This Python 3 environment comes with many helpful analytics libraries installed\n",
    "# It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n",
    "# For example, here's several helpful packages to load\n",
    "\n",
    "import numpy as np # linear algebra\n",
    "import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n",
    "\n",
    "# Input data files are available in the read-only \"../input/\" directory\n",
    "# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n",
    "\n",
    "import os\n",
    "for dirname, _, filenames in os.walk('/kaggle/input'):\n",
    "    for filename in filenames:\n",
    "        print(os.path.join(dirname, filename))\n",
    "\n",
    "# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n",
    "# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "fcdcc027",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-23T03:22:36.446089Z",
     "iopub.status.busy": "2025-12-23T03:22:36.445729Z",
     "iopub.status.idle": "2025-12-23T03:22:40.770547Z",
     "shell.execute_reply": "2025-12-23T03:22:40.769710Z"
    },
    "papermill": {
     "duration": 4.329687,
     "end_time": "2025-12-23T03:22:40.772268",
     "exception": false,
     "start_time": "2025-12-23T03:22:36.442581",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "!pip install timm --quiet"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "52314857",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-12-23T03:22:40.778879Z",
     "iopub.status.busy": "2025-12-23T03:22:40.778616Z",
     "iopub.status.idle": "2025-12-23T09:51:58.292636Z",
     "shell.execute_reply": "2025-12-23T09:51:58.291548Z"
    },
    "papermill": {
     "duration": 23357.519867,
     "end_time": "2025-12-23T09:51:58.294440",
     "exception": false,
     "start_time": "2025-12-23T03:22:40.774573",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "\n",
      "================================================================================\n",
      "ðŸŒ¿ DINOv2 Tiled Model - Kaggle Training\n",
      "================================================================================\n",
      "Device: cuda\n",
      "ðŸš€ Multi-GPU: 2 GPUs detected!\n",
      "   GPU 0: Tesla T4\n",
      "   GPU 1: Tesla T4\n",
      "âœ“ Found CSIRO dataset at: /kaggle/input/csiro-biomass\n",
      "Data: /kaggle/input/csiro-biomass\n",
      "\n",
      "ðŸ“‚ Loading data...\n",
      "âœ“ Total images: 357\n",
      "\n",
      "================================================================================\n",
      "FOLD 1/5\n",
      "================================================================================\n",
      "Train size: 285, Val size: 72\n",
      "\n",
      "ðŸ“¥ Loading DINOv2 model (first time downloads ~1.2GB)...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/usr/local/lib/python3.12/dist-packages/torch/utils/data/dataloader.py:627: UserWarning: This DataLoader will create 8 worker processes in total. Our suggested max number of worker in current system is 4, which is smaller than what this DataLoader is going to create. Please be aware that excessive worker creation might get DataLoader running slow or even freeze, lower the worker number to avoid potential slowness/freeze if necessary.\n",
      "  warnings.warn(\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Downloading: \"https://github.com/facebookresearch/dinov2/zipball/main\" to /root/.cache/torch/hub/main.zip\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "/root/.cache/torch/hub/facebookresearch_dinov2_main/dinov2/layers/swiglu_ffn.py:51: UserWarning: xFormers is not available (SwiGLU)\n",
      "  warnings.warn(\"xFormers is not available (SwiGLU)\")\n",
      "/root/.cache/torch/hub/facebookresearch_dinov2_main/dinov2/layers/attention.py:33: UserWarning: xFormers is not available (Attention)\n",
      "  warnings.warn(\"xFormers is not available (Attention)\")\n",
      "/root/.cache/torch/hub/facebookresearch_dinov2_main/dinov2/layers/block.py:40: UserWarning: xFormers is not available (Block)\n",
      "  warnings.warn(\"xFormers is not available (Block)\")\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Downloading: \"https://dl.fbaipublicfiles.com/dinov2/dinov2_vitl14/dinov2_vitl14_pretrain.pth\" to /root/.cache/torch/hub/checkpoints/dinov2_vitl14_pretrain.pth\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1.13G/1.13G [00:04<00:00, 267MB/s]\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ“ Using 2 GPUs with DataParallel!\n",
      "âœ“ Model loaded!\n",
      "GPUs: 2\n",
      "Trainable params: 5,771,269\n",
      "\n",
      "ðŸš€ Starting training...\n",
      "\n",
      "Epoch 1/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1846.1801\n",
      "  Val Loss: 1906.0644\n",
      "  Weighted RÂ²: -1.4299\n",
      "  âœ“ Saved best model (RÂ²: -1.4299)\n",
      "\n",
      "Epoch 2/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1769.2183\n",
      "  Val Loss: 1570.2604\n",
      "  Weighted RÂ²: -1.0502\n",
      "  âœ“ Saved best model (RÂ²: -1.0502)\n",
      "\n",
      "Epoch 3/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1245.6455\n",
      "  Val Loss: 988.2834\n",
      "  Weighted RÂ²: -0.3605\n",
      "  âœ“ Saved best model (RÂ²: -0.3605)\n",
      "\n",
      "Epoch 4/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 792.8994\n",
      "  Val Loss: 768.2558\n",
      "  Weighted RÂ²: -0.1145\n",
      "  âœ“ Saved best model (RÂ²: -0.1145)\n",
      "\n",
      "Epoch 5/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 640.4141\n",
      "  Val Loss: 608.0097\n",
      "  Weighted RÂ²: 0.0018\n",
      "  âœ“ Saved best model (RÂ²: 0.0018)\n",
      "\n",
      "Epoch 6/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 557.5652\n",
      "  Val Loss: 485.0852\n",
      "  Weighted RÂ²: 0.1941\n",
      "  âœ“ Saved best model (RÂ²: 0.1941)\n",
      "\n",
      "Epoch 7/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 435.4973\n",
      "  Val Loss: 383.0858\n",
      "  Weighted RÂ²: 0.3241\n",
      "  âœ“ Saved best model (RÂ²: 0.3241)\n",
      "\n",
      "Epoch 8/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 384.8923\n",
      "  Val Loss: 318.0229\n",
      "  Weighted RÂ²: 0.4009\n",
      "  âœ“ Saved best model (RÂ²: 0.4009)\n",
      "\n",
      "Epoch 9/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 324.4163\n",
      "  Val Loss: 276.4967\n",
      "  Weighted RÂ²: 0.4450\n",
      "  âœ“ Saved best model (RÂ²: 0.4450)\n",
      "\n",
      "Epoch 10/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 273.2956\n",
      "  Val Loss: 253.4766\n",
      "  Weighted RÂ²: 0.4692\n",
      "  âœ“ Saved best model (RÂ²: 0.4692)\n",
      "\n",
      "Epoch 11/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 283.7882\n",
      "  Val Loss: 237.5024\n",
      "  Weighted RÂ²: 0.4882\n",
      "  âœ“ Saved best model (RÂ²: 0.4882)\n",
      "\n",
      "Epoch 12/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 270.4521\n",
      "  Val Loss: 226.9298\n",
      "  Weighted RÂ²: 0.5020\n",
      "  âœ“ Saved best model (RÂ²: 0.5020)\n",
      "\n",
      "Epoch 13/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 241.4805\n",
      "  Val Loss: 222.9557\n",
      "  Weighted RÂ²: 0.5081\n",
      "  âœ“ Saved best model (RÂ²: 0.5081)\n",
      "\n",
      "Epoch 14/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 247.1413\n",
      "  Val Loss: 216.1884\n",
      "  Weighted RÂ²: 0.5166\n",
      "  âœ“ Saved best model (RÂ²: 0.5166)\n",
      "\n",
      "Epoch 15/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 240.9073\n",
      "  Val Loss: 213.3808\n",
      "  Weighted RÂ²: 0.5228\n",
      "  âœ“ Saved best model (RÂ²: 0.5228)\n",
      "\n",
      "Epoch 16/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 237.2131\n",
      "  Val Loss: 206.4746\n",
      "  Weighted RÂ²: 0.5343\n",
      "  âœ“ Saved best model (RÂ²: 0.5343)\n",
      "\n",
      "Epoch 17/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 212.3246\n",
      "  Val Loss: 200.6558\n",
      "  Weighted RÂ²: 0.5421\n",
      "  âœ“ Saved best model (RÂ²: 0.5421)\n",
      "\n",
      "Epoch 18/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 208.5837\n",
      "  Val Loss: 197.5248\n",
      "  Weighted RÂ²: 0.5459\n",
      "  âœ“ Saved best model (RÂ²: 0.5459)\n",
      "\n",
      "Epoch 19/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 191.2021\n",
      "  Val Loss: 196.6222\n",
      "  Weighted RÂ²: 0.5489\n",
      "  âœ“ Saved best model (RÂ²: 0.5489)\n",
      "\n",
      "Epoch 20/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 203.5495\n",
      "  Val Loss: 196.5984\n",
      "  Weighted RÂ²: 0.5496\n",
      "  âœ“ Saved best model (RÂ²: 0.5496)\n",
      "\n",
      "Epoch 21/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 205.5781\n",
      "  Val Loss: 197.3218\n",
      "  Weighted RÂ²: 0.5496\n",
      "  â³ Patience: 1/10\n",
      "\n",
      "Epoch 22/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 204.0751\n",
      "  Val Loss: 195.3977\n",
      "  Weighted RÂ²: 0.5519\n",
      "  âœ“ Saved best model (RÂ²: 0.5519)\n",
      "\n",
      "Epoch 23/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 198.9928\n",
      "  Val Loss: 193.8045\n",
      "  Weighted RÂ²: 0.5543\n",
      "  âœ“ Saved best model (RÂ²: 0.5543)\n",
      "\n",
      "Epoch 24/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 173.7004\n",
      "  Val Loss: 192.9569\n",
      "  Weighted RÂ²: 0.5563\n",
      "  âœ“ Saved best model (RÂ²: 0.5563)\n",
      "\n",
      "Epoch 25/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 213.7658\n",
      "  Val Loss: 192.1321\n",
      "  Weighted RÂ²: 0.5576\n",
      "  âœ“ Saved best model (RÂ²: 0.5576)\n",
      "\n",
      "Epoch 26/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 208.3121\n",
      "  Val Loss: 191.8077\n",
      "  Weighted RÂ²: 0.5580\n",
      "  âœ“ Saved best model (RÂ²: 0.5580)\n",
      "\n",
      "Epoch 27/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 212.1348\n",
      "  Val Loss: 191.6167\n",
      "  Weighted RÂ²: 0.5584\n",
      "  âœ“ Saved best model (RÂ²: 0.5584)\n",
      "\n",
      "Epoch 28/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 194.9680\n",
      "  Val Loss: 191.6747\n",
      "  Weighted RÂ²: 0.5584\n",
      "  âœ“ Saved best model (RÂ²: 0.5584)\n",
      "\n",
      "Epoch 29/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 195.2528\n",
      "  Val Loss: 191.6284\n",
      "  Weighted RÂ²: 0.5586\n",
      "  âœ“ Saved best model (RÂ²: 0.5586)\n",
      "\n",
      "Epoch 30/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 207.3845\n",
      "  Val Loss: 191.6222\n",
      "  Weighted RÂ²: 0.5586\n",
      "  âœ“ Saved best model (RÂ²: 0.5586)\n",
      "\n",
      "================================================================================\n",
      "ðŸŽ‰ TRAINING COMPLETE\n",
      "Best Weighted RÂ²: 0.5586\n",
      "Models saved to: /kaggle/working/experiments/dinov2_tiled/fold_0\n",
      "================================================================================\n",
      "\n",
      "\n",
      "================================================================================\n",
      "FOLD 2/5\n",
      "================================================================================\n",
      "Train size: 285, Val size: 72\n",
      "\n",
      "ðŸ“¥ Loading DINOv2 model (first time downloads ~1.2GB)...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Using cache found in /root/.cache/torch/hub/facebookresearch_dinov2_main\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ“ Using 2 GPUs with DataParallel!\n",
      "âœ“ Model loaded!\n",
      "GPUs: 2\n",
      "Trainable params: 5,771,269\n",
      "\n",
      "ðŸš€ Starting training...\n",
      "\n",
      "Epoch 1/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 2014.3133\n",
      "  Val Loss: 1723.7649\n",
      "  Weighted RÂ²: -1.7593\n",
      "  âœ“ Saved best model (RÂ²: -1.7593)\n",
      "\n",
      "Epoch 2/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1756.5772\n",
      "  Val Loss: 1268.8732\n",
      "  Weighted RÂ²: -1.0986\n",
      "  âœ“ Saved best model (RÂ²: -1.0986)\n",
      "\n",
      "Epoch 3/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1203.9975\n",
      "  Val Loss: 833.4740\n",
      "  Weighted RÂ²: -0.4431\n",
      "  âœ“ Saved best model (RÂ²: -0.4431)\n",
      "\n",
      "Epoch 4/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 823.4132\n",
      "  Val Loss: 680.0192\n",
      "  Weighted RÂ²: -0.3959\n",
      "  âœ“ Saved best model (RÂ²: -0.3959)\n",
      "\n",
      "Epoch 5/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 675.2820\n",
      "  Val Loss: 527.8503\n",
      "  Weighted RÂ²: -0.1665\n",
      "  âœ“ Saved best model (RÂ²: -0.1665)\n",
      "\n",
      "Epoch 6/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 498.3241\n",
      "  Val Loss: 428.7958\n",
      "  Weighted RÂ²: 0.1145\n",
      "  âœ“ Saved best model (RÂ²: 0.1145)\n",
      "\n",
      "Epoch 7/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 385.4262\n",
      "  Val Loss: 358.7109\n",
      "  Weighted RÂ²: 0.2519\n",
      "  âœ“ Saved best model (RÂ²: 0.2519)\n",
      "\n",
      "Epoch 8/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 394.4502\n",
      "  Val Loss: 309.0459\n",
      "  Weighted RÂ²: 0.3232\n",
      "  âœ“ Saved best model (RÂ²: 0.3232)\n",
      "\n",
      "Epoch 9/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 301.6327\n",
      "  Val Loss: 276.5714\n",
      "  Weighted RÂ²: 0.3618\n",
      "  âœ“ Saved best model (RÂ²: 0.3618)\n",
      "\n",
      "Epoch 10/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 271.2781\n",
      "  Val Loss: 260.5860\n",
      "  Weighted RÂ²: 0.3838\n",
      "  âœ“ Saved best model (RÂ²: 0.3838)\n",
      "\n",
      "Epoch 11/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 293.1068\n",
      "  Val Loss: 242.7115\n",
      "  Weighted RÂ²: 0.4117\n",
      "  âœ“ Saved best model (RÂ²: 0.4117)\n",
      "\n",
      "Epoch 12/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 249.3082\n",
      "  Val Loss: 235.0161\n",
      "  Weighted RÂ²: 0.4269\n",
      "  âœ“ Saved best model (RÂ²: 0.4269)\n",
      "\n",
      "Epoch 13/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 249.7731\n",
      "  Val Loss: 233.3494\n",
      "  Weighted RÂ²: 0.4333\n",
      "  âœ“ Saved best model (RÂ²: 0.4333)\n",
      "\n",
      "Epoch 14/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 252.2958\n",
      "  Val Loss: 226.3407\n",
      "  Weighted RÂ²: 0.4464\n",
      "  âœ“ Saved best model (RÂ²: 0.4464)\n",
      "\n",
      "Epoch 15/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 258.3306\n",
      "  Val Loss: 219.9429\n",
      "  Weighted RÂ²: 0.4569\n",
      "  âœ“ Saved best model (RÂ²: 0.4569)\n",
      "\n",
      "Epoch 16/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 230.1264\n",
      "  Val Loss: 217.8129\n",
      "  Weighted RÂ²: 0.4606\n",
      "  âœ“ Saved best model (RÂ²: 0.4606)\n",
      "\n",
      "Epoch 17/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 211.1529\n",
      "  Val Loss: 213.2471\n",
      "  Weighted RÂ²: 0.4699\n",
      "  âœ“ Saved best model (RÂ²: 0.4699)\n",
      "\n",
      "Epoch 18/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 227.5493\n",
      "  Val Loss: 210.6534\n",
      "  Weighted RÂ²: 0.4762\n",
      "  âœ“ Saved best model (RÂ²: 0.4762)\n",
      "\n",
      "Epoch 19/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 209.5159\n",
      "  Val Loss: 208.1577\n",
      "  Weighted RÂ²: 0.4826\n",
      "  âœ“ Saved best model (RÂ²: 0.4826)\n",
      "\n",
      "Epoch 20/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 206.9052\n",
      "  Val Loss: 204.9844\n",
      "  Weighted RÂ²: 0.4889\n",
      "  âœ“ Saved best model (RÂ²: 0.4889)\n",
      "\n",
      "Epoch 21/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 205.2009\n",
      "  Val Loss: 204.8152\n",
      "  Weighted RÂ²: 0.4916\n",
      "  âœ“ Saved best model (RÂ²: 0.4916)\n",
      "\n",
      "Epoch 22/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 218.0490\n",
      "  Val Loss: 202.7420\n",
      "  Weighted RÂ²: 0.4957\n",
      "  âœ“ Saved best model (RÂ²: 0.4957)\n",
      "\n",
      "Epoch 23/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 210.7382\n",
      "  Val Loss: 201.3080\n",
      "  Weighted RÂ²: 0.4989\n",
      "  âœ“ Saved best model (RÂ²: 0.4989)\n",
      "\n",
      "Epoch 24/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 207.9063\n",
      "  Val Loss: 199.2134\n",
      "  Weighted RÂ²: 0.5028\n",
      "  âœ“ Saved best model (RÂ²: 0.5028)\n",
      "\n",
      "Epoch 25/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 207.0463\n",
      "  Val Loss: 198.5013\n",
      "  Weighted RÂ²: 0.5046\n",
      "  âœ“ Saved best model (RÂ²: 0.5046)\n",
      "\n",
      "Epoch 26/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 210.9759\n",
      "  Val Loss: 197.8564\n",
      "  Weighted RÂ²: 0.5061\n",
      "  âœ“ Saved best model (RÂ²: 0.5061)\n",
      "\n",
      "Epoch 27/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 206.8738\n",
      "  Val Loss: 197.2715\n",
      "  Weighted RÂ²: 0.5073\n",
      "  âœ“ Saved best model (RÂ²: 0.5073)\n",
      "\n",
      "Epoch 28/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 198.6385\n",
      "  Val Loss: 197.0235\n",
      "  Weighted RÂ²: 0.5078\n",
      "  âœ“ Saved best model (RÂ²: 0.5078)\n",
      "\n",
      "Epoch 29/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 190.1167\n",
      "  Val Loss: 196.9526\n",
      "  Weighted RÂ²: 0.5080\n",
      "  âœ“ Saved best model (RÂ²: 0.5080)\n",
      "\n",
      "Epoch 30/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 207.0273\n",
      "  Val Loss: 196.9113\n",
      "  Weighted RÂ²: 0.5081\n",
      "  âœ“ Saved best model (RÂ²: 0.5081)\n",
      "\n",
      "================================================================================\n",
      "ðŸŽ‰ TRAINING COMPLETE\n",
      "Best Weighted RÂ²: 0.5081\n",
      "Models saved to: /kaggle/working/experiments/dinov2_tiled/fold_1\n",
      "================================================================================\n",
      "\n",
      "\n",
      "================================================================================\n",
      "FOLD 3/5\n",
      "================================================================================\n",
      "Train size: 286, Val size: 71\n",
      "\n",
      "ðŸ“¥ Loading DINOv2 model (first time downloads ~1.2GB)...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Using cache found in /root/.cache/torch/hub/facebookresearch_dinov2_main\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ“ Using 2 GPUs with DataParallel!\n",
      "âœ“ Model loaded!\n",
      "GPUs: 2\n",
      "Trainable params: 5,771,269\n",
      "\n",
      "ðŸš€ Starting training...\n",
      "\n",
      "Epoch 1/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1989.3169\n",
      "  Val Loss: 1940.8617\n",
      "  Weighted RÂ²: -1.5809\n",
      "  âœ“ Saved best model (RÂ²: -1.5809)\n",
      "\n",
      "Epoch 2/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1743.2114\n",
      "  Val Loss: 1517.2974\n",
      "  Weighted RÂ²: -1.1165\n",
      "  âœ“ Saved best model (RÂ²: -1.1165)\n",
      "\n",
      "Epoch 3/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1231.2222\n",
      "  Val Loss: 895.0940\n",
      "  Weighted RÂ²: -0.3622\n",
      "  âœ“ Saved best model (RÂ²: -0.3622)\n",
      "\n",
      "Epoch 4/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 808.0051\n",
      "  Val Loss: 664.1933\n",
      "  Weighted RÂ²: -0.0426\n",
      "  âœ“ Saved best model (RÂ²: -0.0426)\n",
      "\n",
      "Epoch 5/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 582.4079\n",
      "  Val Loss: 535.6693\n",
      "  Weighted RÂ²: 0.0934\n",
      "  âœ“ Saved best model (RÂ²: 0.0934)\n",
      "\n",
      "Epoch 6/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 435.8538\n",
      "  Val Loss: 500.9178\n",
      "  Weighted RÂ²: 0.1664\n",
      "  âœ“ Saved best model (RÂ²: 0.1664)\n",
      "\n",
      "Epoch 7/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 409.8529\n",
      "  Val Loss: 422.1446\n",
      "  Weighted RÂ²: 0.2688\n",
      "  âœ“ Saved best model (RÂ²: 0.2688)\n",
      "\n",
      "Epoch 8/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 317.8761\n",
      "  Val Loss: 392.1071\n",
      "  Weighted RÂ²: 0.3144\n",
      "  âœ“ Saved best model (RÂ²: 0.3144)\n",
      "\n",
      "Epoch 9/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 290.6757\n",
      "  Val Loss: 361.1614\n",
      "  Weighted RÂ²: 0.3466\n",
      "  âœ“ Saved best model (RÂ²: 0.3466)\n",
      "\n",
      "Epoch 10/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 239.5873\n",
      "  Val Loss: 350.7439\n",
      "  Weighted RÂ²: 0.3593\n",
      "  âœ“ Saved best model (RÂ²: 0.3593)\n",
      "\n",
      "Epoch 11/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 248.2386\n",
      "  Val Loss: 328.8024\n",
      "  Weighted RÂ²: 0.3878\n",
      "  âœ“ Saved best model (RÂ²: 0.3878)\n",
      "\n",
      "Epoch 12/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 237.6490\n",
      "  Val Loss: 314.2428\n",
      "  Weighted RÂ²: 0.4085\n",
      "  âœ“ Saved best model (RÂ²: 0.4085)\n",
      "\n",
      "Epoch 13/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 228.1933\n",
      "  Val Loss: 305.0769\n",
      "  Weighted RÂ²: 0.4220\n",
      "  âœ“ Saved best model (RÂ²: 0.4220)\n",
      "\n",
      "Epoch 14/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 199.9700\n",
      "  Val Loss: 298.5217\n",
      "  Weighted RÂ²: 0.4318\n",
      "  âœ“ Saved best model (RÂ²: 0.4318)\n",
      "\n",
      "Epoch 15/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 195.1594\n",
      "  Val Loss: 291.7858\n",
      "  Weighted RÂ²: 0.4419\n",
      "  âœ“ Saved best model (RÂ²: 0.4419)\n",
      "\n",
      "Epoch 16/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 203.9564\n",
      "  Val Loss: 288.1513\n",
      "  Weighted RÂ²: 0.4482\n",
      "  âœ“ Saved best model (RÂ²: 0.4482)\n",
      "\n",
      "Epoch 17/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 180.3000\n",
      "  Val Loss: 286.0934\n",
      "  Weighted RÂ²: 0.4524\n",
      "  âœ“ Saved best model (RÂ²: 0.4524)\n",
      "\n",
      "Epoch 18/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 207.9776\n",
      "  Val Loss: 281.4566\n",
      "  Weighted RÂ²: 0.4594\n",
      "  âœ“ Saved best model (RÂ²: 0.4594)\n",
      "\n",
      "Epoch 19/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 189.5988\n",
      "  Val Loss: 278.5526\n",
      "  Weighted RÂ²: 0.4642\n",
      "  âœ“ Saved best model (RÂ²: 0.4642)\n",
      "\n",
      "Epoch 20/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 188.5528\n",
      "  Val Loss: 282.3193\n",
      "  Weighted RÂ²: 0.4606\n",
      "  â³ Patience: 1/10\n",
      "\n",
      "Epoch 21/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 174.7438\n",
      "  Val Loss: 278.1298\n",
      "  Weighted RÂ²: 0.4666\n",
      "  âœ“ Saved best model (RÂ²: 0.4666)\n",
      "\n",
      "Epoch 22/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 178.1488\n",
      "  Val Loss: 273.7683\n",
      "  Weighted RÂ²: 0.4726\n",
      "  âœ“ Saved best model (RÂ²: 0.4726)\n",
      "\n",
      "Epoch 23/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 187.0045\n",
      "  Val Loss: 272.4531\n",
      "  Weighted RÂ²: 0.4747\n",
      "  âœ“ Saved best model (RÂ²: 0.4747)\n",
      "\n",
      "Epoch 24/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 182.1827\n",
      "  Val Loss: 271.5548\n",
      "  Weighted RÂ²: 0.4763\n",
      "  âœ“ Saved best model (RÂ²: 0.4763)\n",
      "\n",
      "Epoch 25/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 175.8044\n",
      "  Val Loss: 270.5099\n",
      "  Weighted RÂ²: 0.4778\n",
      "  âœ“ Saved best model (RÂ²: 0.4778)\n",
      "\n",
      "Epoch 26/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 186.6390\n",
      "  Val Loss: 270.3178\n",
      "  Weighted RÂ²: 0.4783\n",
      "  âœ“ Saved best model (RÂ²: 0.4783)\n",
      "\n",
      "Epoch 27/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 172.4867\n",
      "  Val Loss: 269.9827\n",
      "  Weighted RÂ²: 0.4788\n",
      "  âœ“ Saved best model (RÂ²: 0.4788)\n",
      "\n",
      "Epoch 28/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 183.0267\n",
      "  Val Loss: 269.7049\n",
      "  Weighted RÂ²: 0.4793\n",
      "  âœ“ Saved best model (RÂ²: 0.4793)\n",
      "\n",
      "Epoch 29/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 181.8541\n",
      "  Val Loss: 269.4839\n",
      "  Weighted RÂ²: 0.4796\n",
      "  âœ“ Saved best model (RÂ²: 0.4796)\n",
      "\n",
      "Epoch 30/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 165.6984\n",
      "  Val Loss: 269.3983\n",
      "  Weighted RÂ²: 0.4798\n",
      "  âœ“ Saved best model (RÂ²: 0.4798)\n",
      "\n",
      "================================================================================\n",
      "ðŸŽ‰ TRAINING COMPLETE\n",
      "Best Weighted RÂ²: 0.4798\n",
      "Models saved to: /kaggle/working/experiments/dinov2_tiled/fold_2\n",
      "================================================================================\n",
      "\n",
      "\n",
      "================================================================================\n",
      "FOLD 4/5\n",
      "================================================================================\n",
      "Train size: 286, Val size: 71\n",
      "\n",
      "ðŸ“¥ Loading DINOv2 model (first time downloads ~1.2GB)...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Using cache found in /root/.cache/torch/hub/facebookresearch_dinov2_main\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ“ Using 2 GPUs with DataParallel!\n",
      "âœ“ Model loaded!\n",
      "GPUs: 2\n",
      "Trainable params: 5,771,269\n",
      "\n",
      "ðŸš€ Starting training...\n",
      "\n",
      "Epoch 1/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1935.6779\n",
      "  Val Loss: 1668.1944\n",
      "  Weighted RÂ²: -1.7120\n",
      "  âœ“ Saved best model (RÂ²: -1.7120)\n",
      "\n",
      "Epoch 2/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1789.3626\n",
      "  Val Loss: 1239.2080\n",
      "  Weighted RÂ²: -1.0797\n",
      "  âœ“ Saved best model (RÂ²: -1.0797)\n",
      "\n",
      "Epoch 3/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1352.7543\n",
      "  Val Loss: 784.7454\n",
      "  Weighted RÂ²: -0.3567\n",
      "  âœ“ Saved best model (RÂ²: -0.3567)\n",
      "\n",
      "Epoch 4/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 795.0502\n",
      "  Val Loss: 663.2280\n",
      "  Weighted RÂ²: -0.1798\n",
      "  âœ“ Saved best model (RÂ²: -0.1798)\n",
      "\n",
      "Epoch 5/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 657.7903\n",
      "  Val Loss: 543.7376\n",
      "  Weighted RÂ²: -0.0784\n",
      "  âœ“ Saved best model (RÂ²: -0.0784)\n",
      "\n",
      "Epoch 6/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 532.0666\n",
      "  Val Loss: 422.0237\n",
      "  Weighted RÂ²: 0.1324\n",
      "  âœ“ Saved best model (RÂ²: 0.1324)\n",
      "\n",
      "Epoch 7/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 455.4115\n",
      "  Val Loss: 359.5813\n",
      "  Weighted RÂ²: 0.2400\n",
      "  âœ“ Saved best model (RÂ²: 0.2400)\n",
      "\n",
      "Epoch 8/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 384.9714\n",
      "  Val Loss: 318.1543\n",
      "  Weighted RÂ²: 0.3049\n",
      "  âœ“ Saved best model (RÂ²: 0.3049)\n",
      "\n",
      "Epoch 9/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 283.1344\n",
      "  Val Loss: 289.1455\n",
      "  Weighted RÂ²: 0.3465\n",
      "  âœ“ Saved best model (RÂ²: 0.3465)\n",
      "\n",
      "Epoch 10/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 286.2385\n",
      "  Val Loss: 277.5789\n",
      "  Weighted RÂ²: 0.3613\n",
      "  âœ“ Saved best model (RÂ²: 0.3613)\n",
      "\n",
      "Epoch 11/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 255.9637\n",
      "  Val Loss: 268.0641\n",
      "  Weighted RÂ²: 0.3785\n",
      "  âœ“ Saved best model (RÂ²: 0.3785)\n",
      "\n",
      "Epoch 12/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 260.4058\n",
      "  Val Loss: 266.3617\n",
      "  Weighted RÂ²: 0.3833\n",
      "  âœ“ Saved best model (RÂ²: 0.3833)\n",
      "\n",
      "Epoch 13/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 248.9365\n",
      "  Val Loss: 246.0400\n",
      "  Weighted RÂ²: 0.4158\n",
      "  âœ“ Saved best model (RÂ²: 0.4158)\n",
      "\n",
      "Epoch 14/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 254.5680\n",
      "  Val Loss: 238.3945\n",
      "  Weighted RÂ²: 0.4289\n",
      "  âœ“ Saved best model (RÂ²: 0.4289)\n",
      "\n",
      "Epoch 15/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 239.0739\n",
      "  Val Loss: 234.3566\n",
      "  Weighted RÂ²: 0.4361\n",
      "  âœ“ Saved best model (RÂ²: 0.4361)\n",
      "\n",
      "Epoch 16/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 224.7308\n",
      "  Val Loss: 223.7881\n",
      "  Weighted RÂ²: 0.4523\n",
      "  âœ“ Saved best model (RÂ²: 0.4523)\n",
      "\n",
      "Epoch 17/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 240.0137\n",
      "  Val Loss: 216.7094\n",
      "  Weighted RÂ²: 0.4639\n",
      "  âœ“ Saved best model (RÂ²: 0.4639)\n",
      "\n",
      "Epoch 18/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 232.2365\n",
      "  Val Loss: 213.3818\n",
      "  Weighted RÂ²: 0.4701\n",
      "  âœ“ Saved best model (RÂ²: 0.4701)\n",
      "\n",
      "Epoch 19/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 212.7664\n",
      "  Val Loss: 211.2423\n",
      "  Weighted RÂ²: 0.4755\n",
      "  âœ“ Saved best model (RÂ²: 0.4755)\n",
      "\n",
      "Epoch 20/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 219.7574\n",
      "  Val Loss: 208.7165\n",
      "  Weighted RÂ²: 0.4806\n",
      "  âœ“ Saved best model (RÂ²: 0.4806)\n",
      "\n",
      "Epoch 21/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 213.1285\n",
      "  Val Loss: 206.9046\n",
      "  Weighted RÂ²: 0.4846\n",
      "  âœ“ Saved best model (RÂ²: 0.4846)\n",
      "\n",
      "Epoch 22/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 217.7295\n",
      "  Val Loss: 206.2089\n",
      "  Weighted RÂ²: 0.4867\n",
      "  âœ“ Saved best model (RÂ²: 0.4867)\n",
      "\n",
      "Epoch 23/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 215.0854\n",
      "  Val Loss: 206.4971\n",
      "  Weighted RÂ²: 0.4869\n",
      "  âœ“ Saved best model (RÂ²: 0.4869)\n",
      "\n",
      "Epoch 24/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 210.9892\n",
      "  Val Loss: 204.3338\n",
      "  Weighted RÂ²: 0.4904\n",
      "  âœ“ Saved best model (RÂ²: 0.4904)\n",
      "\n",
      "Epoch 25/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 198.0367\n",
      "  Val Loss: 202.7035\n",
      "  Weighted RÂ²: 0.4929\n",
      "  âœ“ Saved best model (RÂ²: 0.4929)\n",
      "\n",
      "Epoch 26/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 205.5842\n",
      "  Val Loss: 202.6471\n",
      "  Weighted RÂ²: 0.4932\n",
      "  âœ“ Saved best model (RÂ²: 0.4932)\n",
      "\n",
      "Epoch 27/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 206.6888\n",
      "  Val Loss: 202.1837\n",
      "  Weighted RÂ²: 0.4941\n",
      "  âœ“ Saved best model (RÂ²: 0.4941)\n",
      "\n",
      "Epoch 28/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 209.9360\n",
      "  Val Loss: 201.7581\n",
      "  Weighted RÂ²: 0.4949\n",
      "  âœ“ Saved best model (RÂ²: 0.4949)\n",
      "\n",
      "Epoch 29/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 205.5132\n",
      "  Val Loss: 201.5890\n",
      "  Weighted RÂ²: 0.4952\n",
      "  âœ“ Saved best model (RÂ²: 0.4952)\n",
      "\n",
      "Epoch 30/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 202.6990\n",
      "  Val Loss: 201.4596\n",
      "  Weighted RÂ²: 0.4954\n",
      "  âœ“ Saved best model (RÂ²: 0.4954)\n",
      "\n",
      "================================================================================\n",
      "ðŸŽ‰ TRAINING COMPLETE\n",
      "Best Weighted RÂ²: 0.4954\n",
      "Models saved to: /kaggle/working/experiments/dinov2_tiled/fold_3\n",
      "================================================================================\n",
      "\n",
      "\n",
      "================================================================================\n",
      "FOLD 5/5\n",
      "================================================================================\n",
      "Train size: 286, Val size: 71\n",
      "\n",
      "ðŸ“¥ Loading DINOv2 model (first time downloads ~1.2GB)...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Using cache found in /root/.cache/torch/hub/facebookresearch_dinov2_main\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ“ Using 2 GPUs with DataParallel!\n",
      "âœ“ Model loaded!\n",
      "GPUs: 2\n",
      "Trainable params: 5,771,269\n",
      "\n",
      "ðŸš€ Starting training...\n",
      "\n",
      "Epoch 1/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1876.6239\n",
      "  Val Loss: 2139.0910\n",
      "  Weighted RÂ²: -1.7458\n",
      "  âœ“ Saved best model (RÂ²: -1.7458)\n",
      "\n",
      "Epoch 2/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1569.6013\n",
      "  Val Loss: 1638.0165\n",
      "  Weighted RÂ²: -1.1957\n",
      "  âœ“ Saved best model (RÂ²: -1.1957)\n",
      "\n",
      "Epoch 3/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 1250.8863\n",
      "  Val Loss: 1061.0071\n",
      "  Weighted RÂ²: -0.5045\n",
      "  âœ“ Saved best model (RÂ²: -0.5045)\n",
      "\n",
      "Epoch 4/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 817.1392\n",
      "  Val Loss: 750.0093\n",
      "  Weighted RÂ²: -0.1255\n",
      "  âœ“ Saved best model (RÂ²: -0.1255)\n",
      "\n",
      "Epoch 5/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 646.6357\n",
      "  Val Loss: 618.3269\n",
      "  Weighted RÂ²: 0.0265\n",
      "  âœ“ Saved best model (RÂ²: 0.0265)\n",
      "\n",
      "Epoch 6/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 480.7679\n",
      "  Val Loss: 521.1539\n",
      "  Weighted RÂ²: 0.1618\n",
      "  âœ“ Saved best model (RÂ²: 0.1618)\n",
      "\n",
      "Epoch 7/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 431.9336\n",
      "  Val Loss: 431.7548\n",
      "  Weighted RÂ²: 0.2691\n",
      "  âœ“ Saved best model (RÂ²: 0.2691)\n",
      "\n",
      "Epoch 8/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 313.4403\n",
      "  Val Loss: 390.5541\n",
      "  Weighted RÂ²: 0.3196\n",
      "  âœ“ Saved best model (RÂ²: 0.3196)\n",
      "\n",
      "Epoch 9/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 302.5457\n",
      "  Val Loss: 357.6924\n",
      "  Weighted RÂ²: 0.3610\n",
      "  âœ“ Saved best model (RÂ²: 0.3610)\n",
      "\n",
      "Epoch 10/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 254.2198\n",
      "  Val Loss: 327.0235\n",
      "  Weighted RÂ²: 0.3996\n",
      "  âœ“ Saved best model (RÂ²: 0.3996)\n",
      "\n",
      "Epoch 11/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 252.2587\n",
      "  Val Loss: 307.8187\n",
      "  Weighted RÂ²: 0.4241\n",
      "  âœ“ Saved best model (RÂ²: 0.4241)\n",
      "\n",
      "Epoch 12/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 257.3757\n",
      "  Val Loss: 292.4804\n",
      "  Weighted RÂ²: 0.4429\n",
      "  âœ“ Saved best model (RÂ²: 0.4429)\n",
      "\n",
      "Epoch 13/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 222.2313\n",
      "  Val Loss: 281.6807\n",
      "  Weighted RÂ²: 0.4561\n",
      "  âœ“ Saved best model (RÂ²: 0.4561)\n",
      "\n",
      "Epoch 14/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 245.9488\n",
      "  Val Loss: 274.2135\n",
      "  Weighted RÂ²: 0.4673\n",
      "  âœ“ Saved best model (RÂ²: 0.4673)\n",
      "\n",
      "Epoch 15/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 219.4217\n",
      "  Val Loss: 272.1925\n",
      "  Weighted RÂ²: 0.4729\n",
      "  âœ“ Saved best model (RÂ²: 0.4729)\n",
      "\n",
      "Epoch 16/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 215.6291\n",
      "  Val Loss: 269.6974\n",
      "  Weighted RÂ²: 0.4771\n",
      "  âœ“ Saved best model (RÂ²: 0.4771)\n",
      "\n",
      "Epoch 17/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 229.2319\n",
      "  Val Loss: 264.7175\n",
      "  Weighted RÂ²: 0.4837\n",
      "  âœ“ Saved best model (RÂ²: 0.4837)\n",
      "\n",
      "Epoch 18/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 203.7208\n",
      "  Val Loss: 260.8789\n",
      "  Weighted RÂ²: 0.4896\n",
      "  âœ“ Saved best model (RÂ²: 0.4896)\n",
      "\n",
      "Epoch 19/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 204.1283\n",
      "  Val Loss: 254.1668\n",
      "  Weighted RÂ²: 0.4993\n",
      "  âœ“ Saved best model (RÂ²: 0.4993)\n",
      "\n",
      "Epoch 20/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 198.9083\n",
      "  Val Loss: 250.7347\n",
      "  Weighted RÂ²: 0.5055\n",
      "  âœ“ Saved best model (RÂ²: 0.5055)\n",
      "\n",
      "Epoch 21/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 214.8969\n",
      "  Val Loss: 247.8608\n",
      "  Weighted RÂ²: 0.5099\n",
      "  âœ“ Saved best model (RÂ²: 0.5099)\n",
      "\n",
      "Epoch 22/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 192.1246\n",
      "  Val Loss: 246.1205\n",
      "  Weighted RÂ²: 0.5128\n",
      "  âœ“ Saved best model (RÂ²: 0.5128)\n",
      "\n",
      "Epoch 23/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 189.7533\n",
      "  Val Loss: 245.6956\n",
      "  Weighted RÂ²: 0.5139\n",
      "  âœ“ Saved best model (RÂ²: 0.5139)\n",
      "\n",
      "Epoch 24/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 205.7275\n",
      "  Val Loss: 246.2122\n",
      "  Weighted RÂ²: 0.5138\n",
      "  â³ Patience: 1/10\n",
      "\n",
      "Epoch 25/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 193.1728\n",
      "  Val Loss: 245.4913\n",
      "  Weighted RÂ²: 0.5150\n",
      "  âœ“ Saved best model (RÂ²: 0.5150)\n",
      "\n",
      "Epoch 26/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 192.6556\n",
      "  Val Loss: 244.9434\n",
      "  Weighted RÂ²: 0.5157\n",
      "  âœ“ Saved best model (RÂ²: 0.5157)\n",
      "\n",
      "Epoch 27/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 208.9030\n",
      "  Val Loss: 244.6830\n",
      "  Weighted RÂ²: 0.5162\n",
      "  âœ“ Saved best model (RÂ²: 0.5162)\n",
      "\n",
      "Epoch 28/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 203.7242\n",
      "  Val Loss: 244.3267\n",
      "  Weighted RÂ²: 0.5167\n",
      "  âœ“ Saved best model (RÂ²: 0.5167)\n",
      "\n",
      "Epoch 29/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 193.7790\n",
      "  Val Loss: 244.3057\n",
      "  Weighted RÂ²: 0.5169\n",
      "  âœ“ Saved best model (RÂ²: 0.5169)\n",
      "\n",
      "Epoch 30/30\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "                                                         \r"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "  Train Loss: 197.1973\n",
      "  Val Loss: 244.2148\n",
      "  Weighted RÂ²: 0.5170\n",
      "  âœ“ Saved best model (RÂ²: 0.5170)\n",
      "\n",
      "================================================================================\n",
      "ðŸŽ‰ TRAINING COMPLETE\n",
      "Best Weighted RÂ²: 0.5170\n",
      "Models saved to: /kaggle/working/experiments/dinov2_tiled/fold_4\n",
      "================================================================================\n",
      "\n"
     ]
    }
   ],
   "source": [
    "\"\"\"\n",
    "DINOv2 Tiled Training \n",
    "==================================================\n",
    "\n",
    "Copy this entire file into a single Kaggle notebook cell and run.\n",
    "\n",
    "Prerequisites:\n",
    "1. Enable GPU in Kaggle\n",
    "2. Enable Internet (for DINOv2 download)\n",
    "3. Have CSIRO dataset in /kaggle/input/\n",
    "\n",
    "\"\"\"\n",
    "\n",
    "import os\n",
    "import random\n",
    "from pathlib import Path\n",
    "from typing import List, Optional, Tuple, Callable\n",
    "\n",
    "import numpy as np\n",
    "import pandas as pd\n",
    "import torch\n",
    "import torch.nn as nn\n",
    "import torch.optim as optim\n",
    "from torch.utils.data import Dataset, DataLoader\n",
    "from sklearn.model_selection import GroupKFold\n",
    "from tqdm import tqdm\n",
    "from PIL import Image\n",
    "import torchvision.transforms as T\n",
    "import torchvision.transforms.functional as TF\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# CONFIGURATION\n",
    "# =============================================================================\n",
    "\n",
    "class Config:\n",
    "    \"\"\"Training configuration.\"\"\"\n",
    "    # Auto-detect paths\n",
    "    DATA_DIR = None  # Will be auto-detected\n",
    "    OUTPUT_DIR = '/kaggle/working/experiments/dinov2_tiled'\n",
    "    \n",
    "    # Model\n",
    "    BACKBONE = 'dinov2_vitl14'  # or 'dinov2_vitb14' for faster\n",
    "    USE_GLOBAL_STREAM = True\n",
    "    TILE_SIZE = 518\n",
    "    FREEZE_BACKBONE = True\n",
    "    UNFREEZE_LAST_N_BLOCKS = 0\n",
    "    MLP_HIDDEN_DIMS = [1024, 512]\n",
    "    DROPOUT = 0.3\n",
    "    \n",
    "    # Training\n",
    "    EPOCHS = 30\n",
    "    BATCH_SIZE = 32  # Increased for 2 GPUs (4 per GPU)\n",
    "    LR_HEAD = 1e-4\n",
    "    LR_BACKBONE = 1e-5\n",
    "    WEIGHT_DECAY = 1e-4\n",
    "    PATIENCE = 10\n",
    "    \n",
    "    # Loss\n",
    "    TARGET_WEIGHTS = [0.1, 0.1, 0.1, 0.1, 0.5]  # Green, Dead, Clover, GDM, Total\n",
    "    CONSTRAINT_LAMBDA = 0.1\n",
    "    \n",
    "    # CV\n",
    "    N_FOLDS = 5\n",
    "    FOLD = 3  # Train single fold for Kaggle\n",
    "    \n",
    "    # Other\n",
    "    NUM_WORKERS = 8  # Increased for 2 GPUs\n",
    "    SEED = 42\n",
    "    USE_MULTI_GPU = True  # Enable multi-GPU training\n",
    "    \n",
    "    TARGET_COLS = ['Dry_Green_g', 'Dry_Dead_g', 'Dry_Clover_g', 'GDM_g', 'Dry_Total_g']\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# DATA TRANSFORMS\n",
    "# =============================================================================\n",
    "\n",
    "class TileTransform:\n",
    "    \"\"\"Split image into 2x2 tiles + optional global.\"\"\"\n",
    "    \n",
    "    def __init__(self, tile_size=518, include_global=True, augment=False):\n",
    "        self.tile_size = tile_size\n",
    "        self.include_global = include_global\n",
    "        self.augment = augment\n",
    "        \n",
    "        self.normalize = T.Normalize(\n",
    "            mean=[0.485, 0.456, 0.406],\n",
    "            std=[0.229, 0.224, 0.225]\n",
    "        )\n",
    "        self.resize = T.Resize((tile_size, tile_size), interpolation=T.InterpolationMode.BICUBIC, antialias=True)\n",
    "    \n",
    "    def _crop_tile(self, image, tile_idx):\n",
    "        w, h = image.size\n",
    "        half_w, half_h = w // 2, h // 2\n",
    "        positions = {\n",
    "            0: (0, 0, half_w, half_h),\n",
    "            1: (half_w, 0, w, half_h),\n",
    "            2: (0, half_h, half_w, h),\n",
    "            3: (half_w, half_h, w, h),\n",
    "        }\n",
    "        return image.crop(positions[tile_idx])\n",
    "    \n",
    "    def __call__(self, image):\n",
    "        if self.augment:\n",
    "            if random.random() < 0.5:\n",
    "                image = TF.hflip(image)\n",
    "            if random.random() < 0.5:\n",
    "                image = TF.vflip(image)\n",
    "            if random.random() < 0.8:\n",
    "                image = T.ColorJitter(0.2, 0.2, 0.2, 0.1)(image)\n",
    "        \n",
    "        tiles = []\n",
    "        for i in range(4):\n",
    "            tile = self._crop_tile(image, i)\n",
    "            tile = self.resize(tile)\n",
    "            tile = T.ToTensor()(tile)\n",
    "            tile = self.normalize(tile)\n",
    "            tiles.append(tile)\n",
    "        \n",
    "        if self.include_global:\n",
    "            global_img = self.resize(image)\n",
    "            global_img = T.ToTensor()(global_img)\n",
    "            global_img = self.normalize(global_img)\n",
    "            tiles.append(global_img)\n",
    "        \n",
    "        return torch.stack(tiles, dim=0)\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# DATASET\n",
    "# =============================================================================\n",
    "\n",
    "class PastureTiledDataset(Dataset):\n",
    "    \"\"\"Dataset for pasture images with tiling.\"\"\"\n",
    "    \n",
    "    def __init__(self, df, data_dir, transform=None):\n",
    "        self.df = df.reset_index(drop=True)\n",
    "        self.data_dir = Path(data_dir)\n",
    "        self.transform = transform\n",
    "        self.target_cols = ['Dry_Green_g', 'Dry_Dead_g', 'Dry_Clover_g', 'GDM_g', 'Dry_Total_g']\n",
    "    \n",
    "    def __len__(self):\n",
    "        return len(self.df)\n",
    "    \n",
    "    def __getitem__(self, idx):\n",
    "        row = self.df.iloc[idx]\n",
    "        img_path = self.data_dir / row['image_path']\n",
    "        image = Image.open(img_path).convert('RGB')\n",
    "        \n",
    "        if self.transform:\n",
    "            tiles = self.transform(image)\n",
    "        else:\n",
    "            tiles = torch.zeros(5, 3, 518, 518)  # dummy\n",
    "        \n",
    "        targets = torch.tensor([row[col] for col in self.target_cols], dtype=torch.float32)\n",
    "        return tiles, targets\n",
    "\n",
    "\n",
    "def load_train_data(data_dir):\n",
    "    \"\"\"Load and reshape training data.\"\"\"\n",
    "    df_long = pd.read_csv(Path(data_dir) / 'train.csv')\n",
    "    df_long['image_id'] = df_long['sample_id'].str.split('__').str[0]\n",
    "    \n",
    "    df_wide = df_long.pivot(index='image_id', columns='target_name', values='target').reset_index()\n",
    "    image_paths = df_long.groupby('image_id')['image_path'].first()\n",
    "    df_wide['image_path'] = df_wide['image_id'].map(image_paths)\n",
    "    \n",
    "    target_cols = ['Dry_Green_g', 'Dry_Dead_g', 'Dry_Clover_g', 'GDM_g', 'Dry_Total_g']\n",
    "    return df_wide[['image_id', 'image_path'] + target_cols]\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# MODEL\n",
    "# =============================================================================\n",
    "\n",
    "class TiledDinoModel(nn.Module):\n",
    "    \"\"\"DINOv2 with tiled input processing.\"\"\"\n",
    "    \n",
    "    def __init__(self, backbone_name='dinov2_vitl14', num_tiles=5, \n",
    "                 mlp_hidden_dims=[1024, 512], dropout=0.3, freeze_backbone=True):\n",
    "        super().__init__()\n",
    "        \n",
    "        self.backbone = torch.hub.load('facebookresearch/dinov2', backbone_name, pretrained=True)\n",
    "        self.feature_dim = self.backbone.embed_dim\n",
    "        self.num_tiles = num_tiles\n",
    "        \n",
    "        if freeze_backbone:\n",
    "            for param in self.backbone.parameters():\n",
    "                param.requires_grad = False\n",
    "        \n",
    "        # MLP head\n",
    "        layers = []\n",
    "        prev_dim = num_tiles * self.feature_dim\n",
    "        for hidden_dim in mlp_hidden_dims:\n",
    "            layers.extend([\n",
    "                nn.Linear(prev_dim, hidden_dim),\n",
    "                nn.ReLU(inplace=True),\n",
    "                nn.Dropout(p=dropout),\n",
    "            ])\n",
    "            prev_dim = hidden_dim\n",
    "        layers.append(nn.Linear(prev_dim, 5))\n",
    "        self.head = nn.Sequential(*layers)\n",
    "    \n",
    "    def forward(self, tiles):\n",
    "        batch_size, num_tiles, channels, height, width = tiles.shape\n",
    "        tiles_flat = tiles.reshape(batch_size * num_tiles, channels, height, width)\n",
    "        \n",
    "        with torch.set_grad_enabled(self.training):\n",
    "            features = self.backbone(tiles_flat)\n",
    "        \n",
    "        # Use contiguous().view() or reshape() to handle non-contiguous tensors\n",
    "        features = features.contiguous().view(batch_size, num_tiles * self.feature_dim)\n",
    "        return self.head(features)\n",
    "    \n",
    "    def get_trainable_params(self):\n",
    "        return sum(p.numel() for p in self.parameters() if p.requires_grad)\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# LOSSES\n",
    "# =============================================================================\n",
    "\n",
    "class CombinedLoss(nn.Module):\n",
    "    \"\"\"Weighted MSE + physical constraint.\"\"\"\n",
    "    \n",
    "    def __init__(self, target_weights=[0.1, 0.1, 0.1, 0.1, 0.5], constraint_lambda=0.1):\n",
    "        super().__init__()\n",
    "        weights = [w / sum(target_weights) for w in target_weights]\n",
    "        self.register_buffer('weights', torch.tensor(weights, dtype=torch.float32))\n",
    "        self.constraint_lambda = constraint_lambda\n",
    "    \n",
    "    def forward(self, predictions, targets):\n",
    "        # Ensure weights are on the same device as predictions\n",
    "        weights = self.weights.to(predictions.device)\n",
    "        \n",
    "        # Weighted MSE\n",
    "        mse_per_target = (predictions - targets) ** 2\n",
    "        weighted_mse = mse_per_target * weights\n",
    "        main_loss = weighted_mse.sum(dim=1).mean()\n",
    "        \n",
    "        # Physical constraint: Total â‰ˆ Green + Dead + Clover\n",
    "        pred_sum = predictions[:, 0] + predictions[:, 1] + predictions[:, 2]\n",
    "        pred_total = predictions[:, 4]\n",
    "        constraint_loss = ((pred_total - pred_sum) ** 2).mean()\n",
    "        \n",
    "        total_loss = main_loss + self.constraint_lambda * constraint_loss\n",
    "        \n",
    "        return {\n",
    "            'total': total_loss,\n",
    "            'main': main_loss,\n",
    "            'constraint': constraint_loss\n",
    "        }\n",
    "\n",
    "\n",
    "def weighted_r2_score(predictions, targets, weights=[0.1, 0.1, 0.1, 0.1, 0.5]):\n",
    "    \"\"\"Compute weighted RÂ² score.\"\"\"\n",
    "    target_names = ['Dry_Green_g', 'Dry_Dead_g', 'Dry_Clover_g', 'GDM_g', 'Dry_Total_g']\n",
    "    results = {}\n",
    "    weighted_r2 = 0.0\n",
    "    \n",
    "    for i, (name, w) in enumerate(zip(target_names, weights)):\n",
    "        pred_i = predictions[:, i]\n",
    "        target_i = targets[:, i]\n",
    "        \n",
    "        ss_res = ((target_i - pred_i) ** 2).sum()\n",
    "        ss_tot = ((target_i - target_i.mean()) ** 2).sum()\n",
    "        \n",
    "        r2 = 1 - (ss_res / ss_tot) if ss_tot > 1e-8 else torch.tensor(0.0)\n",
    "        results[name] = r2.item()\n",
    "        weighted_r2 += w * r2.item()\n",
    "    \n",
    "    results['weighted_r2'] = weighted_r2\n",
    "    return results\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# TRAINING FUNCTIONS\n",
    "# =============================================================================\n",
    "\n",
    "def train_epoch(model, dataloader, criterion, optimizer, device, scaler=None):\n",
    "    \"\"\"Train one epoch.\"\"\"\n",
    "    model.train()\n",
    "    running_loss = 0.0\n",
    "    num_samples = 0\n",
    "    \n",
    "    for tiles, targets in tqdm(dataloader, desc='Training', leave=False):\n",
    "        tiles, targets = tiles.to(device), targets.to(device)\n",
    "        batch_size = tiles.size(0)\n",
    "        \n",
    "        optimizer.zero_grad()\n",
    "        \n",
    "        if scaler is not None:\n",
    "            with torch.autocast(device_type='cuda', dtype=torch.float16):\n",
    "                outputs = model(tiles)\n",
    "                losses = criterion(outputs, targets)\n",
    "            scaler.scale(losses['total']).backward()\n",
    "            scaler.step(optimizer)\n",
    "            scaler.update()\n",
    "        else:\n",
    "            outputs = model(tiles)\n",
    "            losses = criterion(outputs, targets)\n",
    "            losses['total'].backward()\n",
    "            optimizer.step()\n",
    "        \n",
    "        running_loss += losses['total'].item() * batch_size\n",
    "        num_samples += batch_size\n",
    "    \n",
    "    return running_loss / num_samples\n",
    "\n",
    "\n",
    "def validate(model, dataloader, criterion, device):\n",
    "    \"\"\"Validate model.\"\"\"\n",
    "    model.eval()\n",
    "    running_loss = 0.0\n",
    "    num_samples = 0\n",
    "    all_predictions = []\n",
    "    all_targets = []\n",
    "    \n",
    "    with torch.no_grad():\n",
    "        for tiles, targets in tqdm(dataloader, desc='Validation', leave=False):\n",
    "            tiles, targets = tiles.to(device), targets.to(device)\n",
    "            batch_size = tiles.size(0)\n",
    "            \n",
    "            outputs = model(tiles)\n",
    "            losses = criterion(outputs, targets)\n",
    "            \n",
    "            running_loss += losses['total'].item() * batch_size\n",
    "            num_samples += batch_size\n",
    "            \n",
    "            all_predictions.append(outputs.cpu())\n",
    "            all_targets.append(targets.cpu())\n",
    "    \n",
    "    all_predictions = torch.cat(all_predictions, dim=0)\n",
    "    all_targets = torch.cat(all_targets, dim=0)\n",
    "    \n",
    "    r2_scores = weighted_r2_score(all_predictions, all_targets)\n",
    "    \n",
    "    return {\n",
    "        'loss': running_loss / num_samples,\n",
    "        'r2': r2_scores\n",
    "    }\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# AUTO-DETECT KAGGLE PATHS\n",
    "# =============================================================================\n",
    "\n",
    "def find_csiro_data_dir():\n",
    "    \"\"\"Find CSIRO dataset in Kaggle input.\"\"\"\n",
    "    kaggle_input = Path('/kaggle/input')\n",
    "    \n",
    "    if not kaggle_input.exists():\n",
    "        return '../csiro-biomass'\n",
    "    \n",
    "    for dirname, _, filenames in os.walk(kaggle_input):\n",
    "        if 'train.csv' in filenames and 'test.csv' in filenames:\n",
    "            print(f\"âœ“ Found CSIRO dataset at: {dirname}\")\n",
    "            return dirname\n",
    "    \n",
    "    raise FileNotFoundError(\"Could not find CSIRO dataset in /kaggle/input\")\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# MAIN TRAINING\n",
    "# =============================================================================\n",
    "\n",
    "def main():\n",
    "    \"\"\"Main training function.\"\"\"\n",
    "    config = Config()\n",
    "    \n",
    "    # Set seed\n",
    "    random.seed(config.SEED)\n",
    "    np.random.seed(config.SEED)\n",
    "    torch.manual_seed(config.SEED)\n",
    "    torch.cuda.manual_seed_all(config.SEED)\n",
    "    \n",
    "    # Get device\n",
    "    device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')\n",
    "    n_gpus = torch.cuda.device_count() if torch.cuda.is_available() else 0\n",
    "    \n",
    "    print(f\"\\n{'='*80}\")\n",
    "    print(f\"ðŸŒ¿ DINOv2 Tiled Model - Kaggle Training\")\n",
    "    print(f\"{'='*80}\")\n",
    "    print(f\"Device: {device}\")\n",
    "    if n_gpus > 1:\n",
    "        print(f\"ðŸš€ Multi-GPU: {n_gpus} GPUs detected!\")\n",
    "        for i in range(n_gpus):\n",
    "            print(f\"   GPU {i}: {torch.cuda.get_device_name(i)}\")\n",
    "    elif n_gpus == 1:\n",
    "        print(f\"GPU: {torch.cuda.get_device_name(0)}\")\n",
    "    \n",
    "    # Find data\n",
    "    if config.DATA_DIR is None:\n",
    "        config.DATA_DIR = find_csiro_data_dir()\n",
    "    print(f\"Data: {config.DATA_DIR}\")\n",
    "    \n",
    "    # Create output dir\n",
    "    Path(config.OUTPUT_DIR).mkdir(parents=True, exist_ok=True)\n",
    "    \n",
    "    # Load data\n",
    "    print(\"\\nðŸ“‚ Loading data...\")\n",
    "    df = load_train_data(config.DATA_DIR)\n",
    "    print(f\"âœ“ Total images: {len(df)}\")\n",
    "    \n",
    "    # Setup CV\n",
    "    gkf = GroupKFold(n_splits=config.N_FOLDS)\n",
    "    groups = df['image_id'].values\n",
    "    \n",
    "    # Get fold split\n",
    "    for fold_idx, (train_idx, val_idx) in enumerate(gkf.split(df, groups=groups)):\n",
    "        # if fold_idx != config.FOLD:\n",
    "        #     continue\n",
    "        \n",
    "        train_df = df.iloc[train_idx]\n",
    "        val_df = df.iloc[val_idx]\n",
    "        \n",
    "        print(f\"\\n{'='*80}\")\n",
    "        print(f\"FOLD {fold_idx + 1}/{config.N_FOLDS}\")\n",
    "        print(f\"{'='*80}\")\n",
    "        print(f\"Train size: {len(train_df)}, Val size: {len(val_df)}\")\n",
    "        \n",
    "        # Create datasets\n",
    "        train_transform = TileTransform(config.TILE_SIZE, config.USE_GLOBAL_STREAM, augment=True)\n",
    "        val_transform = TileTransform(config.TILE_SIZE, config.USE_GLOBAL_STREAM, augment=False)\n",
    "        \n",
    "        train_dataset = PastureTiledDataset(train_df, config.DATA_DIR, train_transform)\n",
    "        val_dataset = PastureTiledDataset(val_df, config.DATA_DIR, val_transform)\n",
    "        \n",
    "        train_loader = DataLoader(train_dataset, batch_size=config.BATCH_SIZE, shuffle=True, \n",
    "                                  num_workers=config.NUM_WORKERS, pin_memory=True, drop_last=True)\n",
    "        val_loader = DataLoader(val_dataset, batch_size=config.BATCH_SIZE, shuffle=False,\n",
    "                               num_workers=config.NUM_WORKERS, pin_memory=True)\n",
    "        \n",
    "        # Create model\n",
    "        print(\"\\nðŸ“¥ Loading DINOv2 model (first time downloads ~1.2GB)...\")\n",
    "        num_tiles = 5 if config.USE_GLOBAL_STREAM else 4\n",
    "        model = TiledDinoModel(\n",
    "            backbone_name=config.BACKBONE,\n",
    "            num_tiles=num_tiles,\n",
    "            mlp_hidden_dims=config.MLP_HIDDEN_DIMS,\n",
    "            dropout=config.DROPOUT,\n",
    "            freeze_backbone=config.FREEZE_BACKBONE\n",
    "        ).to(device)\n",
    "        \n",
    "        # Multi-GPU support\n",
    "        n_gpus = torch.cuda.device_count()\n",
    "        if config.USE_MULTI_GPU and n_gpus > 1:\n",
    "            print(f\"âœ“ Using {n_gpus} GPUs with DataParallel!\")\n",
    "            model = nn.DataParallel(model)\n",
    "        \n",
    "        # Get trainable params (handle DataParallel wrapper)\n",
    "        base_model = model.module if hasattr(model, 'module') else model\n",
    "        print(f\"âœ“ Model loaded!\")\n",
    "        print(f\"GPUs: {n_gpus}\")\n",
    "        print(f\"Trainable params: {base_model.get_trainable_params():,}\")\n",
    "        \n",
    "        # Setup training\n",
    "        criterion = CombinedLoss(config.TARGET_WEIGHTS, config.CONSTRAINT_LAMBDA)\n",
    "        optimizer = optim.AdamW(model.parameters(), lr=config.LR_HEAD, weight_decay=config.WEIGHT_DECAY)\n",
    "        scheduler = optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=config.EPOCHS, eta_min=1e-6)\n",
    "        scaler = torch.GradScaler('cuda') if device.type == 'cuda' else None\n",
    "        \n",
    "        # Training loop\n",
    "        best_r2 = float('-inf')\n",
    "        patience_counter = 0\n",
    "        history = []\n",
    "        \n",
    "        fold_dir = Path(config.OUTPUT_DIR) / f'fold_{fold_idx}'\n",
    "        fold_dir.mkdir(parents=True, exist_ok=True)\n",
    "        \n",
    "        print(f\"\\nðŸš€ Starting training...\")\n",
    "        \n",
    "        for epoch in range(config.EPOCHS):\n",
    "            print(f\"\\nEpoch {epoch + 1}/{config.EPOCHS}\")\n",
    "            \n",
    "            # Train\n",
    "            train_loss = train_epoch(model, train_loader, criterion, optimizer, device, scaler)\n",
    "            \n",
    "            # Validate\n",
    "            val_results = validate(model, val_loader, criterion, device)\n",
    "            \n",
    "            scheduler.step()\n",
    "            \n",
    "            weighted_r2 = val_results['r2']['weighted_r2']\n",
    "            \n",
    "            print(f\"  Train Loss: {train_loss:.4f}\")\n",
    "            print(f\"  Val Loss: {val_results['loss']:.4f}\")\n",
    "            print(f\"  Weighted RÂ²: {weighted_r2:.4f}\")\n",
    "            \n",
    "            history.append({\n",
    "                'epoch': epoch + 1,\n",
    "                'train_loss': train_loss,\n",
    "                'val_loss': val_results['loss'],\n",
    "                'weighted_r2': weighted_r2\n",
    "            })\n",
    "            \n",
    "            # Save best model (handle DataParallel wrapper)\n",
    "            if weighted_r2 > best_r2:\n",
    "                best_r2 = weighted_r2\n",
    "                patience_counter = 0\n",
    "                # Save underlying model if using DataParallel\n",
    "                model_to_save = model.module if hasattr(model, 'module') else model\n",
    "                torch.save(model_to_save.state_dict(), fold_dir / 'best_model.pth')\n",
    "                print(f\"  âœ“ Saved best model (RÂ²: {best_r2:.4f})\")\n",
    "            else:\n",
    "                patience_counter += 1\n",
    "                print(f\"  â³ Patience: {patience_counter}/{config.PATIENCE}\")\n",
    "            \n",
    "            if patience_counter >= config.PATIENCE:\n",
    "                print(f\"\\nâš ï¸ Early stopping at epoch {epoch + 1}\")\n",
    "                break\n",
    "        \n",
    "        # Save history\n",
    "        pd.DataFrame(history).to_csv(fold_dir / 'history.csv', index=False)\n",
    "        \n",
    "        print(f\"\\n{'='*80}\")\n",
    "        print(f\"ðŸŽ‰ TRAINING COMPLETE\")\n",
    "        print(f\"Best Weighted RÂ²: {best_r2:.4f}\")\n",
    "        print(f\"Models saved to: {fold_dir}\")\n",
    "        print(f\"{'='*80}\\n\")\n",
    "        \n",
    "        #break   Only train one fold\n",
    "\n",
    "\n",
    "# =============================================================================\n",
    "# RUN\n",
    "# =============================================================================\n",
    "\n",
    "if __name__ == '__main__':\n",
    "    main()\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ce91b077",
   "metadata": {
    "papermill": {
     "duration": 0.102134,
     "end_time": "2025-12-23T09:51:58.502219",
     "exception": false,
     "start_time": "2025-12-23T09:51:58.400085",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": []
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "ec88a527",
   "metadata": {
    "papermill": {
     "duration": 0.102519,
     "end_time": "2025-12-23T09:51:58.709448",
     "exception": false,
     "start_time": "2025-12-23T09:51:58.606929",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "nvidiaTeslaT4",
   "dataSources": [
    {
     "databundleVersionId": 14254895,
     "sourceId": 112509,
     "sourceType": "competition"
    },
    {
     "modelId": 540874,
     "modelInstanceId": 526827,
     "sourceId": 694709,
     "sourceType": "modelInstanceVersion"
    }
   ],
   "dockerImageVersionId": 31236,
   "isGpuEnabled": true,
   "isInternetEnabled": true,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 23370.214693,
   "end_time": "2025-12-23T09:52:02.817554",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2025-12-23T03:22:32.602861",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
